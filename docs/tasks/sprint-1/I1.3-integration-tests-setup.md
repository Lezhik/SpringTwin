# I1.3 - Настроить Integration тесты для REST API

## Метаданные задачи

| Поле | Значение |
|------|----------|
| **Название** | Настроить Integration тесты для REST API |
| **Дата создания** | 2026-02-21 |
| **Статус** | Новая |
| **Приоритет** | High |
| **Спринт** | Sprint 1 |
| **Категория** | Infrastructure |

---

## Описание

Настроить инфраструктуру для интеграционных тестов REST API endpoints. Integration тесты обеспечивают:

1. Тестирование REST API без браузера (через WebTestClient)
2. Проверку работы репозиториев с Neo4j Embedded
3. Валидацию мапперов и сервисов в Spring контексте
4. Быстрое выполнение по сравнению с E2E тестами

### Структура тестов

- `src/test/java/twin/spring/integration/app/` - Тесты для модуля app
- `src/test/java/twin/spring/integration/project/` - Тесты для модуля project
- `src/test/java/twin/spring/integration/architecture/` - Тесты для модуля architecture
- `src/test/java/twin/spring/integration/analysis/` - Тесты для модуля analysis
- `src/test/java/twin/spring/integration/report/` - Тесты для модуля report
- `src/test/java/twin/spring/integration/migration/` - Тесты для модуля migration
- `src/test/java/twin/spring/integration/mcp/` - Тесты для модуля mcp

---

## Mermaid диаграмма

```mermaid
graph TD
    subgraph Integration Test Configuration
        base_test[BaseIntegrationTest.java]
        web_test_client[WebTestClient]
        test_profiles[Test Profiles]
    end
    
    subgraph Test Structure
        integration[src/test/java/twin/spring/integration/]
        app_tests[app/*IntegrationTest.java]
        project_tests[project/*IntegrationTest.java]
        architecture_tests[architecture/*IntegrationTest.java]
    end
    
    subgraph Spring Boot Test
        spring_test[@SpringBootTest]
        neo4j_config[TestNeo4jConfig]
        random_port[RANDOM_PORT]
    end
    
    subgraph Test Data
        profiles[src/test/java/twin/spring/profiles/]
        project_profile[ProjectTestProfile]
        architecture_profile[ArchitectureTestProfile]
    end
    
    base_test --> web_test_client
    base_test --> test_profiles
    
    integration --> app_tests
    integration --> project_tests
    integration --> architecture_tests
    
    app_tests --> base_test
    project_tests --> base_test
    architecture_tests --> base_test
    
    base_test --> spring_test
    spring_test --> neo4j_config
    spring_test --> random_port
    
    test_profiles --> profiles
    profiles --> project_profile
    profiles --> architecture_profile
</graph>
```

---

## DTO определения

Для данной задачи DTO не требуются, так как это инфраструктурная задача.

---

## Тестовые сценарии

### Unit тесты

| ID | Описание | Ожидаемый результат |
|----|----------|---------------------|
| UT-I1.3-01 | Проверка BaseIntegrationTest | Класс компилируется |
| UT-I1.3-02 | Проверка тестовых профилей | Профили создаются |

### Интеграционные тесты

| ID | Описание | Шаги | Ожидаемый результат |
|----|----------|------|---------------------|
| IT-I1.3-01 | WebTestClient GET запрос | 1. Создать тестовый endpoint<br>2. Выполнить GET | Ответ 200 OK |
| IT-I1.3-02 | WebTestClient POST запрос | 1. Создать тестовый endpoint<br>2. Выполнить POST | Ответ 201 Created |
| IT-I1.3-03 | Тест с Neo4j Embedded | 1. Сохранить сущность<br>2. Прочитать из БД | Данные совпадают |
| IT-I1.3-04 | Тестовые профили | 1. Использовать профиль<br>2. Создать данные | Данные создаются |

### E2E тесты

| ID | Описание | Шаги | Ожидаемый результат |
|----|----------|------|---------------------|
| E2E-I1.3-01 | Запуск всех integration тестов | 1. Выполнить `gradlew.bat test --tests "twin.spring.integration.*"` | Все тесты проходят |

---

## Критерии приемки

- [ ] Создан абстрактный класс BaseIntegrationTest.java в src/test/java/twin/spring/integration/
- [ ] BaseIntegrationTest настроен с @SpringBootTest и WebTestClient
- [ ] BaseIntegrationTest импортирует TestNeo4jConfig через @Import
- [ ] Настроен @BeforeEach для очистки БД перед каждым тестом
- [ ] Создан пример integration теста для тестового endpoint
- [ ] Созданы базовые тестовые профили в src/test/java/twin/spring/profiles/
- [ ] Профили содержат фабричные методы для создания тестовых данных
- [ ] Команда `gradlew.bat test --tests "twin.spring.integration.*"` выполняется успешно
- [ ] WebTestClient корректно работает с REST API
- [ ] Neo4j Embedded корректно интегрируется в тесты

---

## Зависимости

- **B1.2** - Создать package структуру для всех модулей
- **I1.2** - Настроить Neo4j Embedded для тестов

---

## Примечания

- Использовать WebTestClient для тестирования REST API (без браузера)
- Использовать @AutoConfigureWebTestClient для автоматической настройки
- Каждый тест должен быть независимым (очистка БД в @BeforeEach)
- Использовать тестовые профили для создания тестовых данных
- Не использовать @DataJpaTest или @DataNeo4jTest - только @SpringBootTest
- StepVerifier для тестирования реактивных потоков