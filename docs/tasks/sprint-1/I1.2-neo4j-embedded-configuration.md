# I1.2 - Настроить Neo4j Embedded для тестов

## Метаданные задачи

| Поле | Значение |
|------|----------|
| **Название** | Настроить Neo4j Embedded для тестов |
| **Дата создания** | 2026-02-18 |
| **Статус** | Новая |
| **Приоритет** | High |
| **Спринт** | Sprint 1 |
| **Категория** | Infrastructure |

---

## Описание

Настроить Neo4j Embedded для интеграционного и E2E тестирования. Neo4j Embedded обеспечивает:

1. In-memory базу данных для быстрых тестов
2. Не требует Docker или внешних зависимостей
3. Автоматическую интеграцию с Spring Boot тестами
4. Воспроизводимость тестов

### Конфигурация

- **TestNeo4jConfig** - Конфигурация Neo4j Embedded для тестов
- **In-memory режим** - Для максимальной скорости выполнения тестов

---

## Mermaid диаграмма

```mermaid
graph TD
    subgraph Neo4j Embedded Configuration
        test_config[TestNeo4jConfig.java]
        neo4j_embedded[Neo4j Embedded]
        in_memory[In-Memory Mode]
    end
    
    subgraph Test Structure
        unit_tests[Unit Tests - Mock]
        integration_tests[Integration Tests - Neo4j Embedded]
        e2e_tests[E2E Tests - Neo4j Embedded]
    end
    
    subgraph Spring Boot Test
        spring_test[@SpringBootTest]
        web_test_client[WebTestClient]
        random_port[RANDOM_PORT]
    end
    
    test_config --> neo4j_embedded
    neo4j_embedded --> in_memory
    
    integration_tests --> test_config
    e2e_tests --> test_config
    
    integration_tests --> spring_test
    spring_test --> web_test_client
    e2e_tests --> spring_test
    spring_test --> random_port
</graph>
```

---

## DTO определения

Для данной задачи DTO не требуются, так как это инфраструктурная задача.

---

## Тестовые сценарии

### Unit тесты

| ID | Описание | Ожидаемый результат |
|----|----------|---------------------|
| UT-I1.2-01 | Проверка конфигурации TestNeo4jConfig | Конфигурация валидна |
| UT-I1.2-02 | Проверка создания Driver bean | Bean создается корректно |

### Интеграционные тесты

| ID | Описание | Шаги | Ожидаемый результат |
|----|----------|------|---------------------|
| IT-I1.2-01 | Запуск Neo4j Embedded | 1. Запустить тест с Neo4j | База запускается |
| IT-I1.2-02 | Подключение к Neo4j | 1. Запустить embedded<br>2. Подключиться | Подключение успешно |
| IT-I1.2-03 | Создание узлов | 1. Создать ClassNode<br>2. Сохранить | Узел сохраняется |
| IT-I1.2-04 | Остановка Neo4j | 1. Завершить тест | База останавливается |

### E2E тесты

| ID | Описание | Шаги | Ожидаемый результат |
|----|----------|------|---------------------|
| E2E-I1.2-01 | Интеграционный тест с БД | 1. Запустить тест<br>2. Проверить данные | Тест проходит |
| E2E-I1.2-02 | E2E тест с Neo4j | 1. Запустить Spring Boot<br>2. Выполнить E2E тест | Тесты проходят |

---

## Критерии приемки

- [ ] Добавлена зависимость neo4j-harness в build.gradle.kts (test scope)
- [ ] Создан TestNeo4jConfig.java в src/test/java/twin/spring/config/
- [ ] Настроен Neo4j Embedded в in-memory режиме
- [ ] Настроена интеграция с @SpringBootTest через @Import
- [ ] Driver bean доступен для инъекции в тестах
- [ ] База автоматически запускается при запуске тестов
- [ ] База автоматически останавливается после тестов
- [ ] Команда `gradlew.bat test` выполняется успешно
- [ ] Интеграционные тесты проходят с Neo4j Embedded
- [ ] E2E тесты проходят с Neo4j Embedded

---

## Зависимости

- **B1.1** - Настроить Gradle multi-module структуру

---

## Примечания

- Использовать Neo4j Harness для embedded режима
- In-memory режим для максимальной скорости
- Не требует Docker
- Использовать @TestConfiguration для TestNeo4jConfig
- Использовать @Primary для переопределения основного Driver
- База создается заново для каждого тестового класса (изоляция)